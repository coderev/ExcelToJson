Private Sub Workbook_BeforeSave(ByVal SaveAsUI As Boolean, Cancel As Boolean)
    Dim pathSeparator As String
    Dim sheet As Worksheet
    Dim className As String
    Dim noteStr As String
    Dim classStr As String
    Dim tableEnumStr As String
    Dim keyPropEnumStr As String

    pathSeparator = Application.pathSeparator
    className = "ConfEnums"

    noteStr = "/*" & Chr(10) & " * This file is automatically generated by Config Tools."
    noteStr = noteStr & Chr(10) & " * Do not modify this file -- YOUR CHANGES WILL BE ERASED!" & Chr(10) & " */"

    classStr = "public static class " & className & Chr(10) & "{" & Chr(10) & Chr(9) & "public static readonly string[] fileNames = {"
    tableEnumStr = "public enum " & className & "FileEnum" & Chr(10) & "{"

    For Each sheet In ThisWorkbook.Sheets
        Dim sheetName As String
        Dim dataFilePath As String

        sheetName = sheet.Name
        If InStr(sheetName, "ignore_") = 1 Then
            dataFilePath = ThisWorkbook.path & pathSeparator & "Config" & pathSeparator & Right(sheetName, Len(sheetName) - 2) & ".conf"
            If FileExists(dataFilePath) Then Kill (dataFilePath)
        Else
            Dim row As Integer
            Dim col As Integer
            Dim rowMax As Integer
            Dim colMax As Integer
            Dim cellStr As String
            Dim isGenKeyEnum As Boolean
            Dim isGenPropEnum As Boolean

            If Not IsNumeric(Right(sheetName, 1)) Then
                isGenKeyEnum = True
                isGenPropEnum = True
                classStr = classStr & Chr(10) & Chr(9) & Chr(9) & Chr(34) & sheetName & Chr(34) & ","
                tableEnumStr = tableEnumStr & Chr(10) & Chr(9) & sheetName & ","
            Else
                isGenKeyEnum = False
                isGenPropEnum = False
            End If

            If isGenKeyEnum Or isGenPropEnum Then
                cellStr = sheet.Cells(1, 1)
                If cellStr = "" Or Left(cellStr, 1) <> "K" Then isGenKeyEnum = False
                If cellStr = "" Or Right(cellStr, 1) <> "P" Then isGenPropEnum = False
            End If

            ' Key Enum
            If isGenKeyEnum Then keyPropEnumStr = keyPropEnumStr & "public enum " & sheetName & "Enum" & Chr(10) & "{"
            row = 1
            Do While sheet.Cells(row + 1, 1) <> ""
                row = row + 1
                If isGenKeyEnum Then keyPropEnumStr = keyPropEnumStr & Chr(10) & Chr(9) & sheet.Cells(row, 1) & ","
            Loop
            rowMax = row
            If isGenKeyEnum Then keyPropEnumStr = keyPropEnumStr & Chr(10) & "}" & Chr(10) & Chr(10)

            ' Property Enum
            If isGenPropEnum Then keyPropEnumStr = keyPropEnumStr & "public enum Key" & sheetName & "Enum" & Chr(10) & "{"
            col = 1
            Do While sheet.Cells(1, col + 1) <> ""
                col = col + 1
                If isGenPropEnum Then keyPropEnumStr = keyPropEnumStr & Chr(10) & Chr(9) & sheet.Cells(1, col) & ","
            Loop
            colMax = col
            If isGenPropEnum Then keyPropEnumStr = keyPropEnumStr & Chr(10) & "}" & Chr(10) & Chr(10)

            ' JSON Data
            Dim dataStr As String
            Dim valueStr As String
            Dim i As Integer
            Dim n As Integer
            Dim c As String
            Dim cp As Long
            dataStr = "{" & Chr(34) & sheetName & Chr(34) & ":{"
            For row = 2 To rowMax
                dataStr = dataStr & Chr(34) & sheet.Cells(row, 1) & Chr(34) & ":{"
                For col = 2 To colMax
                    dataStr = dataStr & Chr(34) & sheet.Cells(1, col) & Chr(34) & ":"
                    cellStr = sheet.Cells(row, col)
                    If cellStr <> "" Then
                        valueStr = ""
                        n = Len(cellStr)
                        For i = 1 To n
                            c = Mid(cellStr, i, 1)
                            cp = AscW(c)
                            If cp < 0 Then cp = 65536 + cp
                            If cp < 256 Then
                                Select Case cp
                                    Case 34
                                        valueStr = valueStr & Chr(92) & Chr(34)
                                    Case 92
                                        valueStr = valueStr & Chr(92) & Chr(92)
                                    Case 8
                                        valueStr = valueStr & Chr(92) & "b"
                                    Case 12
                                        valueStr = valueStr & Chr(92) & "f"
                                    Case 10
                                        valueStr = valueStr & Chr(92) & "n"
                                    Case 13
                                        valueStr = valueStr & Chr(92) & "r"
                                    Case 9
                                        valueStr = valueStr & Chr(92) & "t"
                                    Case Else
                                        valueStr = valueStr & c
                                End Select
                            ElseIf cp < 4096 Then
                                valueStr = valueStr & Chr(92) & "u0" & Hex(cp)
                            Else
                                valueStr = valueStr & Chr(92) & "u" & Hex(cp)
                            End If
                        Next i
                        dataStr = dataStr & valueStr
                    Else
                        dataStr = dataStr & "0"
                    End If
                    If col < colMax Then dataStr = dataStr & ","
                Next col
                dataStr = dataStr & "}"
                If row < rowMax Then dataStr = dataStr & ","
            Next row
            dataStr = dataStr & "}}"

            ' Write JSON Data to file
            dataFilePath = ThisWorkbook.path & pathSeparator & "Config" & pathSeparator & sheetName & ".conf"
            Dim dataFileNum As Integer
            dataFileNum = FreeFile()
            Open dataFilePath For Output As #dataFileNum
            Print #dataFileNum, dataStr
            Close #dataFileNum
        End If
    Next

    classStr = classStr & Chr(10) & Chr(9) & "};" & Chr(10) & "}"
    tableEnumStr = tableEnumStr & Chr(10) & "}"

    ' Write Script File
    Dim scriptStr As String
    scriptStr = noteStr & Chr(10) & Chr(10) & classStr & Chr(10) & Chr(10) & tableEnumStr & Chr(10) & Chr(10) & keyPropEnumStr
    Dim scriptFilePath As String
    scriptFilePath = ThisWorkbook.path & pathSeparator & "Enums" & pathSeparator & className & ".cs"
    Dim scriptFileNum As Integer
    scriptFileNum = FreeFile()
    Open scriptFilePath For Output As #scriptFileNum
    Print #scriptFileNum, scriptStr
    Close #scriptFileNum
End Sub

Function FileExists(ByVal path As String) As Boolean
    On Error Resume Next
    If Dir(path) <> "" Then FileExists = True Else FileExists = False
    If Err.Number <> 0 Then FileExists = False
End Function

